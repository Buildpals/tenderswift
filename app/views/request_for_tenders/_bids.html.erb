<div class="graph mb-4">
  <canvas id="barChart" class="mb-2"></canvas>
</div>


<div class="d-flex w-100">
  <%= form_with(model: @request, local: true, id: 'some-form', class: 'form-inline ml-auto') do |form| %>

      <div class="form-group">
        <%= form.label :budget, class: 'mr-2' %>
        <%= form.hidden_field :budget_currency, value: @request.contract_sum_currency %>
        <div class="input-group input-group-sm">
          <span class="input-group-addon" id="sizing-addon1">
            <%= @request.contract_sum_currency %>
          </span>
          <%= form.text_field :budget, id: :request_budget,
                              class: 'form-control', data: {'save-on-change': true} %>
          <span class="input-group-btn">
          <%= form.submit 'Calculate Budget Differences', class: 'btn btn-primary' %>
        </span>
        </div>
      </div>


  <% end %>
</div>



<br/>
<br/>

<%= render 'shortlisted_bids' %>

<%= render 'disqualified_bids' %>

<br/>
<br/>

<%= render 'winner_display' %>

<%= render 'confirm_winner_of_bid' %>

<%= render 'error_message_modal'%>

<%= render 'notify_disqualified_contractors'%>

<%= render 'award_contract' %>

<%= render 'done' %>



<script>


var winnerName;

var participantId;

function getCompanyName(array){
  var companyName="";
  for(i=0; i < array.length; i++){
    companyName = companyName +" "+ array[i]
  }
  return companyName
}

function displayWinnerName(){
  $('.winner-name').each( function(i,e){
    e.innerHTML = winnerName;
  });
}

$(function () {
    $('#final-email-message').val($('.final-message').text());
    $('#send-out-final-invitation').parsley().on('field:validated', function() {
    var ok = $('.parsley-error').length === 0;
    $('.bs-callout-warning').toggleClass('hidden', ok);
  })
  .on('form:submit', function() {
    $('#final-email-message').val($('.final-message').text());
    return true;
  });
});

$(function () {
    $('#notify-disqualified-contractors-message').val($('.message-disqualified-contractors').text());
    $('#notify-disqualified-contractors-message').parsley().on('field:validated', function() {
    var ok = $('.parsley-error').length === 0;
    $('.bs-callout-warning').toggleClass('hidden', ok);
  })
  .on('#notify-disqualified-contractors:submit', function() {
    $('#notify-disqualified-contractors-message').val($('.message-disqualified-contractors').text());
    console.log($('#notify-disqualified-contractors-message').val());
    return true;

  });
});

$('#btn-notify-contrators').click(function(e){
  $('#disqualifiedContractorsModal').modal('hide');
  //make modal unclosable
  $('#finalMessageModal').modal({
    backdrop: 'static',
    keyboard: false
  });
  $('#finalMessageModal').modal('show');
});

$('#finalMessageModal').on('shown.bs.modal', function(e){
  $('.modal-header .winner-name').innerHTML = winnerName; //Put winner's name in the notification
  $('.final-message').focus();
});

//Get winner's name and award contract when QS clicks award contract button
$('.accept').click( function(e){
  winnerName = getCompanyName($(this)[0].children[0].classList);
  participantId = $(this)[0].children[1].classList[0];
});

//Confirm who is winning the bid 
$('#confirm-winner').click( function(e){
    $.ajax({
      url: "/requests/set_winner/"+<%= @request.id %>+"/"+participantId,
      type: "POST",
      data: {},
      success: function(response){
        //make modal unclosable
        $('#disqualifiedContractorsModal').modal({
          backdrop: 'static',
          keyboard: false
        });
        $('#disqualifiedContractorsModal').modal('show');
       },
      error: function(response){ 
        $('#errorModal').modal('show');
       }
  });
});

$('#disqualifiedContractorsModal').on('show.bs.modal', function(e){
  displayWinnerName();
});

$('#disqualifiedContractorsModal').on('shown.bs.modal', function(e){
  $('.message-disqualified-contractors').focus();
});

//Insert winner's name in to alert when modal appears
$('#alertModal').on('shown.bs.modal', function(e){
  displayWinnerName();
});

$('#finalMessageModal').on('hidden.bs.modal', function (e) {
  $("#doneModal").modal('show');
});

$('#doneModal').on('hidden.bs.modal', function (e) {
  location.reload();
});

</script>