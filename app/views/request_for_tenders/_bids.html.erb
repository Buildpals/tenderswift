<div class="graph mb-4">
  <canvas id="barChart" class="mb-2"></canvas>
</div>


<div class="d-flex w-100">
  <%= form_with(model: @request, local: true, id: 'some-form', class: 'form-inline ml-auto') do |form| %>

      <div class="form-group">
        <%= form.label :budget, class: 'mr-2' %>
        <%= form.hidden_field :budget_currency, value: @request.contract_sum_currency %>
        <div class="input-group input-group-sm">
          <span class="input-group-addon" id="sizing-addon1">
            <%= @request.contract_sum_currency %>
          </span>
          <%= form.text_field :budget, id: :request_budget,
                              class: 'form-control', data: {'save-on-change': true} %>
          <span class="input-group-btn">
          <%= form.submit 'Calculate Budget Differences', class: 'btn btn-primary' %>
        </span>
        </div>
      </div>


  <% end %>
</div>



<br/>
<br/>

<div class="d-flex w-100 justify-content-between mb-2 form-inline">
  <h5>Shortlisted Bids</h5>
  <% if @request.participants.bid_list.where('rating >= 0').size > 1 %>
    <a href=""
      class="btn btn-sm btn-primary pull-right" data-toggle="modal" data-target="#finalMessageModal">
    <span class="fa fa-envelope"></span>
  </a>
  <% end %>
</div>

<table class="table table-striped table-hover mb-5">
  <thead class="thead-light">
  <tr>
    <th>Company</th>
    <th>Bid</th>
    <th>Difference</th>
    <th>Bid time</th>
    <th>Rating</th>
    <th></th>
  </tr>
  </thead>
  <tbody>
  <% @request.participants.bid_list.where('rating >= 0').order(rating: :desc).each do |participant| %>
      <tr>
        <td>
          <span data-toggle="tooltip" data-placement="top" title="<%= participant.email %>">
              <%= participant.name %>
          </span>
        </td>
        <td>
          <%= @request.contract_sum_currency %> <%= participant.bid %>
        </td>
        <td>
          <%= @request.contract_sum_currency %> <%= participant.bid_difference %>
          <small>(<%= participant.bid_difference_as_percentage %>)</small>
        </td>
        <td><small><%= participant.bid_submission_time.to_formatted_s(:short) %></small></td>
        <td>
          <% participant.rating.times do %>
            <span class="fa fa-star text-warning"></span>
          <% end %>
        </td>
        <td>
          <%= link_to 'View bid', participant_boq_path(participant)%>
        </td>
      </tr>
  <% end %>
  </tbody>
</table>

<div class="d-flex w-100 justify-content-between mb-2 form-inline">
  <h5>Disqualified Bids</h5>
</div>

<table class="table table-striped table-hover">
  <thead class="thead-light">
  <tr>
    <th>Company</th>
    <th>Bid</th>
    <th>Difference</th>
    <th>Bid time</th>
    <th>Rating</th>
    <th></th>
  </tr>
  </thead>
  <tbody>
  <% @request.participants.bid_list.where('rating < 0').order(rating: :desc).each do |participant| %>
      <tr>
        <td>
          <span data-toggle="tooltip" data-placement="top" title="<%= participant.email %>">
              <%= participant.name %>
          </span>
        </td>
        <td>
          <%= @request.contract_sum_currency %> <%= participant.bid %>
        </td>
        <td>
          <%= @request.contract_sum_currency %> <%= participant.bid_difference %>
          <small>(<%= participant.bid_difference_as_percentage %>)</small>
        </td>
        <td><small><%= participant.bid_submission_time.to_formatted_s(:short) %></small></td>
        <td>
          <span class="text-danger">Disqualified</span>
        </td>
        <td>
          <%= link_to 'View bid', participant_boq_path(participant) %>
        </td>
      </tr>
  <% end %>
  </tbody>
</table>



<div class="modal fade" id="finalMessageModal" tabindex="-1" role="dialog" aria-labelledby="finalMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="finalMessageModalLabel">Send email to shortlisted contractors</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <%= form_with url: request_send_out_final_invitation_url(@request.id) do |form| %>
          <%= form.text_area :final_email_message, { class: 'form-control', id: 'final-email-message'} %>
      </div>
      <div class="modal-footer">
        <%= form.submit "Send Message", {class: 'btn btn-success', data: { disable_with: 'Sending Email...'}} %>
        <% end %>
      </div>
    </div>
  </div>
</div>